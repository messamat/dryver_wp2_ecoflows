---
title: "Report_WP2_multiorganism"
format: html
editor: visual
---

```{r set-up}
library(data.table)
library(flextable)
library(ggpubr)
library(targets)

source('_targets.R')
```

## General information

```{r set-up}
tar_load(allvars_merged)
allvars_merged$dt_summarized[, list(total_sites=uniqueN(site), 
                                    pr=.SD[stream_type=='PR', uniqueN(site)],
                                    npr=.SD[stream_type=='TR', uniqueN(site)]), 
                             by=country]

tar_load(env_dt)
check <- env_dt[, .N, by=.(site, state_of_flow)] %>% 
  dcast(site~state_of_flow) %>%
  .[, total_n := sum(c(`F`, D, IP), na.rm=T), by=site]
check
```

```{r mod tabl}
#Check unique miv taxa
tar_load(bio_dt)
check <- melt(bio_dt$miv, id.vars = intersect(metacols, names(bio_dt$miv)))[, unique(variable)] %>%
    .[grepl('gen.', .)] %>%
  as.character


#Check unique diatom taxa
check_dia <- melt(bio_dt$dia_sedi, 
              id.vars = intersect(metacols, names(bio_dt$dia_sedi))) %>%
  rbind(melt(bio_dt$dia_biof, 
              id.vars = intersect(metacols, names(bio_dt$dia_biof))),
        use.bames=T, fill=T) %>%
  .[value>0,] %>%
  .[!duplicated(variable),]
check_dia[value>0,length(unique(gsub(' ', '_', variable)))]

#Check unique fungi taxa
check_fun <- melt(bio_dt$fun_sedi, 
              id.vars = intersect(metacols, names(bio_dt$fun_sedi))) %>%
  rbind(melt(bio_dt$fun_biof, 
              id.vars = intersect(metacols, names(bio_dt$fun_biof))),
        use.bames=T, fill=T) %>%
  .[value>0,] %>%
  .[!duplicated(variable),]
check_fun[value>0,length(unique(gsub(' ', '_', variable)))]

#Check unique bacteria taxa
check_bac <- melt(bio_dt$bac_sedi, 
              id.vars = intersect(metacols, names(bio_dt$bac_sedi))) %>%
  rbind(melt(bio_dt$bac_biof, 
              id.vars = intersect(metacols, names(bio_dt$bac_biof))),
        use.bames=T, fill=T) %>%
  .[value>0,] %>%
  .[!duplicated(variable),]
check_bac[value>0,length(unique(gsub(' ', '_', variable)))]

check_cor_div_habvol()#Check range of intermittence in the Albarine
tar_load(allvars_summarized)
check_fr <- allvars_summarized$dt[!duplicated(site) & country == 'France',
                                     .(DurD_samp, stream_type)]
allvars_summarized$dt[!duplicated(site), .N, 
                         by=.(stream_type, country)]
```


```{r maps} 
in_ssn_summarized <- tar_read(ssn_eu_summarized)

map_durdsamp <- map_ssn_facets(in_ssn = in_ssn_summarized[[1]]$ssn, 
               in_pts = 'obs',
               ptcolor_col = "DurD_samp", 
               facet_col = 'country',
               linewidth_col = 'qsim_avg',
               linecolor_col = "DurD_samp",
               page_title = "Proportion of zero-flow days over sampling period",
               shape_col = 'stream_type',
               nbreaks = 10,
               cover_zero = TRUE
)
ggsave(file.path(figdir, 'map_DurD_samp.pdf'),
       map_durdsamp, height = 12, width=8)
```