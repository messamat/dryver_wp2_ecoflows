---
title: "SSN Version Fit Comparison"
format: html
jupyter: false
editor: visual
---

```{r}
#| label: Setup
source('_targets.R')
```

# Load and inspect the original fit (v0.2.1)
```{r}
#| label: Load and inspect the original fit
orig_list <- tar_read(ssn_richness_hydrowindow)[[1]]$ssn_list
fit_old <- orig_list$exponential_exponential_spherical 

summary(fit_old)
```

# Use attributes of the old fit to refit exactly, but with v0.3.0
```{r}
#| label: Use attributes of the old fit to refit exactly
fit_new <- ssn_lm(
  formula = fit_old$formula,
  ssn.object = fit_old$ssn.object,
  tailup_type = str_split(attr(fit_old$coefficients$params_object$tailup, 'class'), '_')[[1]][2],
  taildown_type = str_split(attr(fit_old$coefficients$params_object$taildown, 'class'), '_')[[1]][2],
  euclid_type = str_split(attr(fit_old$coefficients$params_object$euclid, 'class'), '_')[[1]][2],
  additive = fit_old$additive,
  estmethod = fit_old$estmethod,
  random = fit_old$random,
  partition_factor = fit_old$partition_factor
)

summary(fit_new)

print(fit_old$coefficients$params_object)
print(fit_new$coefficients$params_object)
```

# Fit null models
```{r}
#| label: Fit a null model
fit_null <- function(ssn_lm_obj) {
  ssn_lm(
    formula = as.formula(paste0(all.vars(ssn_lm_obj$formula)[1], ' ~ 1')),
    ssn.object = ssn_lm_obj$ssn.object,
    tailup_type = str_split(attr(ssn_lm_obj$coefficients$params_object$tailup, 'class'), '_')[[1]][2],
    taildown_type = str_split(attr(ssn_lm_obj$coefficients$params_object$taildown, 'class'), '_')[[1]][2],
    euclid_type = str_split(attr(ssn_lm_obj$coefficients$params_object$euclid, 'class'), '_')[[1]][2],
    additive = ssn_lm_obj$additive,
    estmethod = ssn_lm_obj$estmethod,
    random = ssn_lm_obj$random,
    partition_factor = ssn_lm_obj$partition_factor
  )
}

null_old <- fit_null(fit_old)
null_new <- fit_null(fit_new)

summary(null_old)
summary(null_new)

get_dev <- function(fit) deviance(fit)
get_pseudoR2 <- function(fit, null) 1 - get_dev(fit) / get_dev(null)

results <- data.frame(
  model = c("old_full", "old_null", "new_full", "new_null"),
  deviance = c(get_dev(fit_old), get_dev(null_old),
               get_dev(fit_new), get_dev(null_new)),
  pseudoR2 = c(get_pseudoR2(fit_old, null_old), NA,
               get_pseudoR2(fit_new, null_new), NA)
)

results
```